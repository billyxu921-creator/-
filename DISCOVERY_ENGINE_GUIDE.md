# 全网热点发现引擎使用指南

## 📋 功能概述

**Discovery Engine（全网热点发现引擎）** 是一个自动化工具，用于识别小红书和微博上讨论度异常升高的股票板块。

### 核心功能

1. **多源探测**
   - 小红书财经频道推荐流（50条笔记）
   - 微博财经热搜榜
   - 微博股票超话活跃内容

2. **强制反爬策略**
   - headless=False（显示浏览器，支持扫码登录）
   - 随机等待 5.5-12.2 秒
   - 拟人化缓慢滚动
   - 真实User-Agent随机切换
   - 验证码蜂鸣提示

3. **AI智能发现**
   - 对比今日与昨日词频
   - 识别动量最大的3个非预设板块
   - 分析板块火爆原因

4. **Markdown简报**
   - 生成【全网雷达：你可能错过的热门机会】报告
   - 包含热门板块、增长率、火爆原因等

---

## 🚀 快速开始

### 1. 安装依赖

```bash
# 安装Playwright
pip install playwright pandas requests

# 安装浏览器驱动
playwright install chromium
```

### 2. 配置API Key

确保 `config.py` 中已配置DeepSeek API Key：

```python
DEEPSEEK_CONFIG = {
    'api_key': 'sk-8b60ff11aefd4032a572f736087f175f',
    'api_base': 'https://api.deepseek.com/v1',
    'model': 'deepseek-chat'
}
```

### 3. 运行引擎

```bash
# 直接运行
python Discovery_Engine.py

# 或运行测试脚本
python test_discovery_engine.py
```

---

## 📖 详细使用说明

### 基本用法

```python
from Discovery_Engine import DiscoveryEngine

# 创建引擎实例
engine = DiscoveryEngine()

# 运行发现流程
engine.run(
    xhs_count=50,      # 小红书抓取数量
    headless=False     # 显示浏览器窗口
)
```

### 自定义配置

```python
# 使用自定义API Key
engine = DiscoveryEngine(api_key='your_api_key')

# 调整抓取数量
engine.run(xhs_count=100, headless=False)
```

---

## 🔧 工作流程

### 第1步：抓取小红书

1. 启动Chromium浏览器（headless=False）
2. 访问小红书财经频道
3. 如需登录，等待用户扫码
4. 滚动抓取推荐流（目标50条）
5. 提取标题、内容、点赞数、评论数

**反爬策略**：
- 随机等待 5.5-12.2 秒
- 拟人化缓慢滚动（分3-6步）
- 检测验证码并蜂鸣提示

### 第2步：抓取微博

1. 访问微博财经热搜榜
2. 筛选财经相关热搜（包含：股、金融、经济等关键词）
3. 访问股票超话
4. 滚动加载并提取内容

**反爬策略**：
- 随机等待 5.5-12.2 秒
- 拟人化滚动
- 验证码检测

### 第3步：保存今日数据

- 将抓取的数据保存到 `discovery_history/discovery_YYYYMMDD.json`
- 用于明日对比分析

### 第4步：加载昨日数据

- 从历史文件加载昨日数据
- 如果没有昨日数据，使用空对比

### 第5步：AI智能分析

调用DeepSeek API，分析内容：

1. **提取板块关键词**（煤炭、核电、新能源等）
2. **计算词频变化**（今日 vs 昨日）
3. **识别TOP 3热门板块**（增长率最高）
4. **分析火爆原因**（政策催化、大V推荐等）

### 第6步：生成简报

生成Markdown格式的【全网雷达报告】，包含：

- 📡 数据来源统计
- 🌡️ 整体市场情绪
- 🔥 讨论度异常升高的板块 TOP 3
- 📰 今日关键事件
- 💬 热门内容样本

---

## 📊 输出文件

### 1. 原始数据 CSV

**文件名**: `discovery_raw_YYYYMMDD_HHMMSS.csv`

**字段**:
- 标题
- 内容
- 点赞数
- 评论数
- 平台（小红书/微博热搜/微博超话）
- 抓取时间

### 2. 全网雷达简报

**文件名**: `全网雷达报告_YYYYMMDD.md`

**内容结构**:
```markdown
# 【全网雷达：你可能错过的热门机会】

## 📡 数据来源
- 小红书: XX 条
- 微博热搜: XX 条
- 微博超话: XX 条

## 🌡️ 整体市场情绪
> AI分析的市场情绪描述

## 🔥 讨论度异常升高的板块 TOP 3

### 1. 煤炭板块 🚀
**增长率**: 250%
**讨论热度**:
- 今日提及: 45 次
- 昨日提及: 13 次

**火爆原因**: 政策催化，煤炭保供政策出台

**置信度**: 85%

...
```

### 3. 历史数据

**路径**: `discovery_history/discovery_YYYYMMDD.json`

用于存储每日数据，供次日对比分析。

---

## ⚠️ 注意事项

### 1. 登录要求

- **小红书**: 需要扫码登录或账号密码登录
- **微博**: 需要扫码登录或账号密码登录

**操作流程**:
1. 程序检测到需要登录时会暂停
2. 在浏览器窗口中完成登录
3. 登录成功后，在终端按回车继续

### 2. 验证码处理

如果遇到验证码：
1. 程序会发出蜂鸣声提示（macOS使用系统提示音）
2. 在浏览器中手动完成验证码
3. 完成后在终端按回车继续

### 3. 反爬策略

- **不要修改等待时间**：5.5-12.2秒是经过测试的安全范围
- **不要使用headless=True**：容易被识别为爬虫
- **不要频繁运行**：建议每天运行1次

### 4. 数据质量

- 首次运行没有昨日数据，对比分析效果有限
- 建议连续运行3-5天，积累历史数据
- 数据量越大，AI分析越准确

### 5. API限制

- DeepSeek API有调用频率限制
- 如果遇到限流，程序会自动处理
- 建议不要同时运行多个实例

---

## 🐛 常见问题

### Q1: 浏览器无法启动

**解决方案**:
```bash
# 重新安装Playwright浏览器
playwright install chromium
```

### Q2: 登录后仍然提示需要登录

**解决方案**:
- 确保登录成功后页面已跳转
- 等待几秒后再按回车继续
- 如果仍然失败，重新运行程序

### Q3: 抓取数据为空

**可能原因**:
1. 页面结构变化（小红书/微博更新了页面）
2. 网络问题
3. 被反爬拦截

**解决方案**:
- 检查网络连接
- 增加等待时间
- 手动检查页面是否正常加载

### Q4: AI分析失败

**可能原因**:
1. API Key无效
2. 网络问题
3. API限流

**解决方案**:
```python
# 测试API连接
python test_api_key.py
```

### Q5: macOS蜂鸣声不工作

**解决方案**:
程序会自动使用系统提示音（`afplay`），如果不工作：
- 检查系统音量
- 或者查看终端的emoji提示（🔔）

---

## 🔄 最佳实践

### 1. 每日定时运行

使用cron定时任务（macOS/Linux）：

```bash
# 编辑crontab
crontab -e

# 添加定时任务（每天早上9点运行）
0 9 * * * cd /path/to/project && python Discovery_Engine.py
```

### 2. 数据备份

定期备份 `discovery_history` 目录：

```bash
# 备份历史数据
tar -czf discovery_backup_$(date +%Y%m%d).tar.gz discovery_history/
```

### 3. 结果分析

- 关注增长率 > 200% 的板块
- 结合置信度 > 0.7 的结果
- 交叉验证多个数据源

### 4. 风险控制

- 社交媒体热度 ≠ 投资价值
- 建议结合基本面、技术面分析
- 不要盲目追热点

---

## 📚 技术架构

### 核心模块

1. **数据采集模块**
   - `scrape_xiaohongshu()`: 小红书抓取
   - `scrape_weibo()`: 微博抓取
   - 使用Playwright模拟真实浏览器

2. **反爬模块**
   - `random_wait()`: 随机等待
   - `slow_scroll()`: 拟人化滚动
   - `_check_captcha()`: 验证码检测
   - `beep_alert()`: 蜂鸣提示

3. **数据存储模块**
   - `save_today_data()`: 保存今日数据
   - `load_yesterday_data()`: 加载昨日数据
   - JSON格式存储

4. **AI分析模块**
   - `analyze_with_ai()`: 调用DeepSeek API
   - 词频对比分析
   - 板块识别和原因分析

5. **报告生成模块**
   - `generate_report()`: 生成Markdown简报
   - 数据可视化
   - 热门内容展示

### 数据流

```
小红书 ──┐
         ├──> 数据采集 ──> 保存今日数据 ──┐
微博 ────┘                              │
                                        ├──> AI分析 ──> 生成简报
                        加载昨日数据 ──┘
```

---

## 🎯 未来优化方向

1. **支持更多平台**
   - 雪球
   - 东方财富股吧
   - 知乎财经话题

2. **增强AI分析**
   - 情绪趋势预测
   - 板块关联分析
   - 风险预警

3. **可视化报告**
   - 生成HTML交互式报告
   - 词云图
   - 趋势图表

4. **实时监控**
   - WebSocket实时推送
   - 异常波动告警

---

## 📞 技术支持

如有问题，请检查：

1. **日志输出**: 程序会输出详细的执行日志
2. **错误信息**: 查看异常堆栈信息
3. **测试脚本**: 运行 `test_discovery_engine.py` 进行诊断

---

## ⚖️ 免责声明

1. 本工具仅供学习和研究使用
2. 请遵守小红书和微博的服务条款
3. 不要过度频繁抓取，避免给服务器造成压力
4. 社交媒体数据不构成投资建议
5. 投资有风险，决策需谨慎

---

**版本**: v1.0  
**更新日期**: 2026-01-15  
**作者**: AI Assistant
