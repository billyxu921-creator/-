# 🛡️ 防幻觉机制说明

## 📋 概述

为了确保系统生成的投资简报真实可靠，我们在所有使用AI分析的模块中都加入了严格的防幻觉机制。

---

## 🎯 核心原则

### 1. 只基于真实数据
- ✅ 所有分析必须基于提供的真实数据
- ❌ 禁止编造任何日期、股价、新闻或事件

### 2. 明确数据来源
- ✅ 所有股价数据来自AkShare
- ✅ 所有舆情数据来自微博/小红书
- ✅ 所有政客交易数据来自Quiver/Unusual Whales

### 3. 数据不足时明确说明
- ✅ 如果数据不足，明确说明"数据不足，无法判断"
- ✅ 如果没有相关内容，说明"未找到相关内容"
- ❌ 不要为了填充内容而编造信息

### 4. 严格验证股票代码
- ✅ 只推荐真实存在的A股股票
- ✅ 股票代码格式：6位数字（60/688/00/002/300开头）
- ❌ 严禁推荐美股或虚构代码

### 5. 标注过往信息
- ✅ 如果新闻日期不是当日，标注为"过往信息"
- ✅ 明确说明数据的时效性

---

## 🔧 实施细节

### 模块1: AI量化选股器

**防幻觉规则**:
```
1. 只能从提供的股票列表中选择
2. 所有股价数据必须以akshare数据为准
3. 如果舆情评分为0，说明"无舆情数据支持"
4. 禁止编造任何新闻、政策或事件
5. 严禁推荐非A股股票
6. 推荐理由必须基于真实数据
7. 止盈位基于当前价格计算
8. 数据不足时在risk_warning中说明
```

**示例输出**:
```json
{
    "stock_name": "某某股份",
    "stock_code": "600XXX",
    "reason": "基于akshare数据：涨幅3.5%，换手率8.2%，显示资金流入",
    "sentiment_analysis": "无舆情数据支持",
    "target_price": "27.50元（基于当前价格25.60元计算）",
    "risk_warning": "数据不足，建议谨慎"
}
```

### 模块2: 微博情绪分析

**防幻觉规则**:
```
1. 只能基于提供的微博内容分析
2. 如果内容不足，说明"内容不足，无法判断"
3. 不要编造任何微博内容或事件
4. 风险点和机会点必须从微博提取
5. 如果没有提到具体事件，不要编造
6. 日期信息必须来自微博原文
```

**示例输出**:
```json
{
    "sentiment_index": 72,
    "risk_points": [
        "从微博提取：美联储加息预期",
        "从微博提取：美元指数走强",
        "未提及"
    ],
    "opportunity_points": [
        "从微博提取：央行持续购金",
        "从微博提取：通胀预期回升",
        "未提及"
    ],
    "data_quality_note": "部分微博为广告内容，数据质量一般"
}
```

### 模块3: 全网热点发现引擎

**防幻觉规则**:
```
1. 只能基于提供的今日和昨日文本数据
2. 如果没有相关板块信息，说明"未找到相关内容"
3. 禁止编造新闻、政策或事件
4. 增长率必须基于真实数据计算
5. 如果昨日提及次数为0，谨慎判断
6. 严禁推荐非A股板块
7. 火爆原因必须基于文本内容
8. 无法确定原因时说明"原因不明"
```

**示例输出**:
```json
{
    "sector_name": "脑机接口",
    "growth_rate": 900,
    "today_mentions": 50,
    "yesterday_mentions": 5,
    "reason": "基于文本分析：讨论热度激增，但具体原因不明，需进一步观察",
    "confidence": 0.6,
    "data_quality_note": "数据样本较小，结论仅供参考"
}
```

### 模块4: 政客交易追踪

**防幻觉规则**:
```
1. 只能从提供的推文列表中筛选
2. 必须包含实词关键词
3. 排除口水话
4. 不要编造任何推文内容
5. 如果所有推文都是口水话，返回空列表
```

**过滤逻辑**:
```python
# 保留的实词
keywords = ['政策', '法案', '拨款', '项目', '考察', '调研']

# 排除的口水话
spam_words = ['啊', '！！', 'to the moon', '买买买']

# 只保留包含实词且不包含口水话的推文
```

---

## 📊 数据验证机制

### 1. 股票代码验证

```python
def validate_stock_code(code):
    """验证股票代码是否为有效的A股代码"""
    if not code or not code.isdigit() or len(code) != 6:
        return False
    
    # A股有效前缀
    valid_prefixes = ['60', '688', '00', '002', '300']
    return any(code.startswith(prefix) for prefix in valid_prefixes)
```

**示例**:
- ✅ 600000（上海主板）
- ✅ 688001（科创板）
- ✅ 000001（深圳主板）
- ✅ 002001（中小板）
- ✅ 300001（创业板）
- ❌ AAPL（美股）
- ❌ 12345（无效格式）

### 2. 价格验证

```python
def validate_price(price):
    """验证价格是否合理"""
    try:
        price = float(price)
        # A股价格一般在0.01-1000之间
        return 0.01 <= price <= 1000
    except:
        return False
```

**示例**:
- ✅ 25.60元
- ✅ 0.01元（ST股票）
- ✅ 999.99元
- ❌ -10元（负数）
- ❌ 10000元（超出合理范围）

### 3. 日期验证

```python
def validate_date(date_str):
    """验证日期是否为今天或过去"""
    date = datetime.strptime(date_str, '%Y-%m-%d')
    today = datetime.now().date()
    
    # 日期不能是未来
    if date.date() > today:
        return False, False
    
    # 是否为今天
    is_today = date.date() == today
    
    return True, is_today
```

**示例**:
- ✅ 2026-01-15（今天）→ 有效，是今天
- ✅ 2026-01-14（昨天）→ 有效，不是今天，标注"过往信息"
- ❌ 2026-01-16（明天）→ 无效，未来日期

---

## 🎯 输出格式规范

### 1. 明确数据来源

**正确示例**:
```
**数据来源**: AkShare实时行情（2026-01-15 14:30）
```

**错误示例**:
```
根据最新消息...（没有说明来源）
```

### 2. 标注过往信息

**正确示例**:
```
【过往信息】2026-01-10的新闻显示...
```

**错误示例**:
```
最新消息显示...（实际是5天前的新闻）
```

### 3. 数据不足时的说明

**正确示例**:
```
**舆情分析**: 无舆情数据支持，无法判断市场情绪
**风险提示**: 数据不足，建议谨慎投资
```

**错误示例**:
```
**舆情分析**: 市场情绪高涨...（实际没有舆情数据）
```

### 4. 引用具体数据

**正确示例**:
```
**推荐理由**: 
- 技术面：涨幅3.5%（来自akshare），换手率8.2%（来自akshare）
- 舆情面：微博讨论50次，其中3位百万粉丝博主提及
```

**错误示例**:
```
**推荐理由**: 
- 技术面：表现强劲（没有具体数据）
- 舆情面：市场关注度高（没有具体数据）
```

---

## ⚠️ 常见幻觉类型及防范

### 类型1: 编造新闻事件

**幻觉示例**:
```
"某某公司今日宣布重大重组"（实际没有这个新闻）
```

**防范措施**:
- 只能基于提供的真实新闻
- 如果没有新闻，说明"未找到相关新闻"

### 类型2: 编造股价数据

**幻觉示例**:
```
"当前价格28.50元"（实际akshare数据是25.60元）
```

**防范措施**:
- 所有股价必须来自akshare
- 在输出中明确标注数据来源

### 类型3: 编造政策信息

**幻觉示例**:
```
"国家发改委昨日发布新政策"（实际没有这个政策）
```

**防范措施**:
- 只能基于提供的真实文本
- 如果不确定，说明"需进一步核实"

### 类型4: 推荐虚构股票

**幻觉示例**:
```
"推荐NVDA（英伟达）"（这是美股，不是A股）
```

**防范措施**:
- 验证股票代码格式
- 只推荐A股市场股票

### 类型5: 编造日期

**幻觉示例**:
```
"2026年1月20日的数据显示"（今天是1月15日）
```

**防范措施**:
- 验证日期不能是未来
- 明确标注数据时间

---

## 📝 使用建议

### 对于开发者

1. **在调用AI前**:
   - 确保提供完整的真实数据
   - 明确告知AI数据来源
   - 设置清晰的防幻觉规则

2. **在AI输出后**:
   - 验证股票代码格式
   - 验证价格合理性
   - 验证日期有效性
   - 检查是否有编造内容

3. **在生成报告时**:
   - 添加数据来源说明
   - 标注过往信息
   - 说明数据质量
   - 充分的风险提示

### 对于用户

1. **阅读简报时**:
   - 注意数据来源说明
   - 注意"过往信息"标注
   - 注意"数据不足"提示
   - 注意风险提示

2. **使用建议时**:
   - 仅供参考，不构成投资建议
   - 独立判断，不要盲目跟随
   - 结合自己的分析
   - 控制仓位，设置止损

---

## 🔍 质量检查清单

### 生成简报前检查

- [ ] 所有股票代码都是有效的A股代码
- [ ] 所有价格数据来自akshare
- [ ] 所有日期都是今天或过去
- [ ] 没有编造的新闻或事件
- [ ] 数据不足时有明确说明
- [ ] 有充分的风险提示
- [ ] 有明确的数据来源说明

### 发送简报前检查

- [ ] 简报中没有虚构的股票代码
- [ ] 简报中没有未来的日期
- [ ] 简报中没有编造的新闻
- [ ] 过往信息已标注
- [ ] 数据来源已说明
- [ ] 风险提示已添加
- [ ] 免责声明已包含

---

## 📚 相关文档

- [anti_hallucination_prompts.py](anti_hallucination_prompts.py) - 防幻觉提示词配置
- [Quant_Picker.py](Quant_Picker.py) - AI量化选股器（已集成防幻觉）
- [weibo_sentiment_weighted.py](weibo_sentiment_weighted.py) - 微博情绪分析（已集成防幻觉）
- [Discovery_Engine.py](Discovery_Engine.py) - 全网热点发现（已集成防幻觉）
- [politician_trade_tracker.py](politician_trade_tracker.py) - 政客交易追踪（已集成防幻觉）

---

## ✅ 总结

通过实施严格的防幻觉机制，我们确保：

1. ✅ **真实性**: 所有数据都有真实来源
2. ✅ **准确性**: 所有分析都基于真实数据
3. ✅ **透明性**: 明确说明数据来源和质量
4. ✅ **诚实性**: 数据不足时明确说明
5. ✅ **安全性**: 充分的风险提示

**记住**: 宁可说"数据不足"，也不要编造信息！

---

**最后更新**: 2026年1月15日
**版本**: v1.0.0
